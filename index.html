<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Fantasya - Le Jeu Officiel</title>
    <style>
        body { background: #1a1a2e; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; }
        
        #status-bar { background: #16213e; padding: 15px; display: flex; justify-content: space-around; align-items: center; border-bottom: 3px solid #e94560; }
        .stat { font-size: 18px; font-weight: bold; background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; }
        .stat span { color: #e94560; font-size: 22px; }

        #game-board { height: 50vh; display: flex; align-items: center; justify-content: center; gap: 15px; padding: 20px; flex-wrap: wrap; }
        #player-hand { height: 35vh; display: flex; justify-content: center; align-items: center; gap: 8px; padding: 10px; background: rgba(0,0,0,0.4); border-top: 2px solid #444; overflow-x: auto; }

        /* Cartes de base */
        .card { width: 125px; height: 180px; background: white; color: #333; border-radius: 10px; padding: 8px; font-size: 11px; cursor: pointer; transition: all 0.3s; border: 3px solid #333; position: relative; display: flex; flex-direction: column; flex-shrink: 0; }
        
        /* Effet de surbrillance dor√©e */
        .jouable { border-color: #ffd700 !important; box-shadow: 0 0 15px #ffd700; transform: translateY(-5px); }
        
        .card.personnage { border-color: #2196f3; }
        .card.activit√© { border-color: #ff9800; }
        .card.chanson { border-color: #9c27b0 !important; background: #fdf0ff !important; font-style: italic; }
        .card.chanson .card-header { color: #4a148c; }
        .card.objet { border-color: #4caf50; }

        .card-header { font-weight: bold; border-bottom: 1px solid #ccc; margin-bottom: 3px; font-size: 11px; text-align: center; color: #000; height: 30px; display: flex; align-items: center; justify-content: center; }
        .card-img { width: 100%; height: 65px; background: #eee; border-radius: 4px; object-fit: cover; margin-bottom: 3px; }
        .card-rules { flex-grow: 1; font-size: 9px; line-height: 1.1; overflow: hidden; }
        .card-footer { display: flex; justify-content: space-between; font-weight: bold; font-size: 12px; }

        .occupe { opacity: 0.6; filter: grayscale(100%); border: 3px dashed #ff9800 !important; }
        .occupe::after { content: "üí§"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 30px; }
        .note-musique { position: fixed; color: #9c27b0; font-size: 24px; pointer-events: none; z-index: 2000; animation: envoler 2s ease-out forwards; }

@keyframes envoler {
    0% { transform: translateY(0) rotate(0deg); opacity: 1; }
    100% { transform: translateY(-200px) rotate(360deg); opacity: 0; }
}
        #victory-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; }
        button { background: #e94560; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #555; }
        
       #discard-pile {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 100px;
    height: 140px;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid #e94560;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: #e94560;
    overflow: hidden;
    cursor: pointer;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
}

#discard-content {
    width: 100%;
    height: 100%;
    position: relative;
}

/* Petit badge pour le nombre de cartes jet√©es */
#discard-count {
    position: absolute;
    top: -10px;
    right: -10px;
    background: #e94560;
    color: white;
    padding: 2px 6px;
    border-radius: 50%;
    font-weight: bold;
    font-size: 12px;
}
    </style>
</head>
<body>

<div id="victory-screen">
    <h1 style="font-size: 60px; color: #ffd700;">VICTOIRE !</h1>
    <p id="victory-msg"></p>
    <button onclick="location.reload()">Recommencer l'aventure</button>
</div>

<div id="status-bar">
    <div class="stat">Fantaisie: <span id="fantaisie">0</span>/50</div>
    <div class="stat">Imagination: <span id="imagination">5</span></div>
    <div class="stat">Temps: <span id="temps">3</span></div>
    <button id="btn-mulligan" onclick="mulligan()">Mulligan</button>
    <button onclick="finirTour()">Finir le Tour (Sommeil)</button>
</div>
    <div id="discard-pile" onclick="defausserManuelle()">
    <div id="discard-count">0</div>
    <div id="discard-content" style="display:flex; align-items:center; justify-content:center; text-align:center;">
    D√âFAUSSE
    </div>
</div>
<div id="game-board"></div>
<div id="player-hand"></div>
<div class="stat">Pioche: <span id="deck-count">0</span></div>
<script>
    let bddCartes = [], deck = [], mainJoueur = [], activitesEnAttente = [];
    let imagination = 5, temps = 3, scoreFantaisie = 0, mulliganFait = false;
    let pileDefausse = [];
    async function initialiserJeu() {
        try {
            const response = await fetch('./fantasya_cards.json');
            bddCartes = await response.json();
            deck = [...bddCartes].sort(() => 0.5 - Math.random());
            mainJoueur = deck.splice(0, 7);
            actualiserStats();
            afficherMain();
        } catch (e) { alert("Erreur : Fichier JSON introuvable !"); }
    }

    function afficherMain() {
        const handDiv = document.getElementById('player-hand');
        handDiv.innerHTML = "";
        mainJoueur.forEach((carte, index) => {
            const cardEl = document.createElement('div');
            const estJouable = imagination >= carte.cout ? "jouable" : "";
            cardEl.className = `card ${carte.type.toLowerCase()} ${estJouable}`;
            cardEl.innerHTML = `
                <div class="card-header">${carte.nom}</div>
                <img class="card-img" src="./images/${carte.id}.png" onerror="this.src='https://via.placeholder.com/130x70?text=ID+${carte.id}'">
                <div class="card-rules">${carte.regles}</div>
                <div class="card-footer">
                    <span>üíé ${carte.cout}</span>
                    <span>${carte.stats ? '‚öîÔ∏è'+carte.stats.force : '‚ú®'}</span>
                </div>
            `;
            cardEl.onclick = () => jouerCarte(index);
            handDiv.appendChild(cardEl);
        });
    }

    function jouerCarte(index) {
    const carte = mainJoueur[index];
    if (imagination >= carte.cout) {
        // On paie le co√ªt
        imagination -= carte.cout;
        
        if (carte.type === "Personnage") {
            poserSurTerrain(carte);
            appliquerEffet(carte);
        } 
        // Modifie ta fonction jouerCarte pour les Chansons
        // Dans le bloc else if (carte.type === "Chanson") :
        else if (carte.type === "Chanson") {
        effetMusique();
        appliquerEffet(carte);
        ajouterADefausse(carte); // <--- AJOUTE √áA
}
        else if (carte.type === "Activit√©") {
            if (temps >= 1) {
                lancerActivite(carte);
            } else {
                imagination += carte.cout; // Rembourse si pas de temps
                alert("Pas assez de Temps !");
                return;
            }
        }

        // Retirer la carte de la main
        mainJoueur.splice(index, 1);
        actualiserStats();
        afficherMain();
    } else {
        alert("Pas assez d'Imagination !");
    }
}

    function appliquerEffet(carte) {
    switch(carte.id) {
        // --- PERSONNAGES ---
        case "0005": scoreFantaisie += 5; break; // Baloo
        case "0041": temps += 2; break; // Grand-M√®re Feuillage
        
        // --- CHANSONS (Effets imm√©diats) ---
        case "0002": // Au Bout du R√™ve
            imagination += 3;
            alert("‚ô´ Au Bout du R√™ve : +3 Imagination !");
            break;
        case "0016": // Ce R√™ve Bleu
            piger(2);
            alert("‚ô´ Ce R√™ve Bleu : Vous piochez 2 cartes !");
            break;
        case "0040": // Lib√©r√©e, D√©livr√©e
            // Effet : Redonne tout le Temps
            temps = 3;
            alert("‚ô´ Lib√©r√©e, D√©livr√©e : Votre Temps est r√©initialis√© !");
            break;
        case "0050": // Je suis ton ami
            // Effet : Donne de la Fantaisie pour chaque perso sur le terrain
            const nbPersos = document.querySelectorAll('#game-board .card.personnage').length;
            scoreFantaisie += (nbPersos * 2);
            alert(`‚ô´ Je suis ton ami : +${nbPersos * 2} Fantaisie !`);
            break;
        case "0091": // Sous l'Oc√©an
            // Effet : Piochez 1 carte pour chaque Activit√© en cours
            const nbAct = activitesEnAttente.length;
            piger(nbAct);
            alert(`‚ô´ Sous l'Oc√©an : +${nbAct} cartes pioch√©es !`);
            break;
    }
    actualiserStats();
}
    
    function piger(nb) {
        for(let i=0; i<nb; i++) if(deck.length > 0) mainJoueur.push(deck.shift());
    }

    function poserSurTerrain(carte) {
        const board = document.getElementById('game-board');
        const cardEl = document.createElement('div');
        cardEl.className = "card personnage";
        cardEl.innerHTML = `<div class="card-header">${carte.nom}</div><img class="card-img" src="./images/${carte.id}.png"><div class="card-footer">üõ°Ô∏è ${carte.stats.endurance}</div>`;
        board.appendChild(cardEl);
    }

    function lancerActivite(carte) {
        const libres = document.querySelectorAll('#game-board .card.personnage:not(.occupe)');
        if (libres.length > 0) {
            temps -= 1;
            libres[0].classList.add('occupe');
            activitesEnAttente.push({ carte: carte, element: libres[0] });
        } else { imagination += carte.cout; alert("Il faut un personnage libre !"); }
    }

    function finirTour() {
        // 1. R√©soudre Activit√©s
        activitesEnAttente.forEach(act => {
            let gain = (parseInt(act.carte.id) % 2 === 0) ? 6 : 10; // Simulation de gain
            scoreFantaisie += gain;
            act.element.classList.remove('occupe');
        });
        activitesEnAttente = [];

        // 2. Pioche et D√©fausse (Limite 10 cartes)
        piger(1);
        if (mainJoueur.length > 10) {
            alert("Trop de cartes ! D√©fausse automatique de l'exc√©dent.");
            mainJoueur = mainJoueur.slice(0, 10);
        }

        imagination = 5; temps = 3;
        actualiserStats();
        afficherMain();
    }

    function mulligan() {
        if(!mulliganFait) {
            deck.push(...mainJoueur);
            deck.sort(() => 0.5 - Math.random());
            mainJoueur = deck.splice(0, 7);
            mulliganFait = true;
            document.getElementById('btn-mulligan').disabled = true;
            afficherMain();
        }
    }

    function actualiserStats() {
    // On calcule le bonus actuel pour l'afficher
    const personnagesSurTerrain = document.querySelectorAll('#game-board .card.personnage');
    let bonusActuel = 0;
    personnagesSurTerrain.forEach(p => {
        const f = p.querySelector('.card-footer').innerText.match(/‚öîÔ∏è(\d+)/);
        if(f) bonusActuel += parseInt(f[1]);
    });

    document.getElementById('imagination').innerText = imagination;
    // On peut ajouter un petit texte √† c√¥t√© si bonus > 0
    if(bonusActuel > 0) {
        document.getElementById('imagination').innerHTML += ` <small style="color:#00ffcc">(+${bonusActuel})</small>`;
    }

    document.getElementById('temps').innerText = temps;
    document.getElementById('fantaisie').innerText = scoreFantaisie;
    document.getElementById('deck-count').innerText = deck.length;
    // ... reste de ta fonction victoire ...
}
    }
   function ajouterADefausse(carte) {
    pileDefausse.push(carte);
    const pileDiv = document.getElementById('discard-content');
    const countDiv = document.getElementById('discard-count');
    
    // On affiche l'image de la derni√®re carte jet√©e
    pileDiv.innerHTML = `
        <img src="./images/${carte.id}.png" 
             style="width:100%; height:100%; object-fit:cover; opacity:0.7;"
             onerror="this.src='https://via.placeholder.com/100x140?text=${carte.nom}'">
    `;
    countDiv.innerText = pileDefausse.length;
}

// Modifie aussi ta fonction defausserManuelle pour appeler ajouterADefausse(carte)
    // 2. D√©fausse Automatique (Limite de 10 cartes √† la fin du tour)
    function verifierLimiteMain() {
    if (mainJoueur.length > 10) {
        let surplus = mainJoueur.length - 10;
        // On retire les cartes les plus anciennes (les premi√®res de la main)
        mainJoueur.splice(0, surplus); 
        alert("Limite de 10 cartes d√©pass√©e ! " + surplus + " carte(s) envoy√©e(s) √† la d√©fausse.");
    }
}

    // 3. Mise √† jour de finirTour pour inclure la v√©rification
   function finirTour() {
    // 1. R√©soudre les Activit√©s (ton code existant)
    let totalGainFantaisie = 0;
    activitesEnAttente.forEach(act => {
        let gain = (parseInt(act.carte.id) % 2 === 0) ? 6 : 10;
        scoreFantaisie += gain;
        totalGainFantaisie += gain;
        act.element.classList.remove('occupe');
    });
    activitesEnAttente = [];

    // 2. CALCUL DE L'IMAGINATION BONUS (NOUVEAU)
    // On va chercher tous les personnages pos√©s sur le plateau
    const personnagesSurTerrain = document.querySelectorAll('#game-board .card.personnage');
    let bonusImagination = 0;

    personnagesSurTerrain.forEach(persoEl => {
        // On r√©cup√®re la force (on cherche le texte apr√®s l'ic√¥ne ‚öîÔ∏è)
        const statsTxt = persoEl.querySelector('.card-footer').innerText;
        const forceMatch = statsTxt.match(/‚öîÔ∏è(\d+)/); 
        if (forceMatch) {
            bonusImagination += parseInt(forceMatch[1]);
        }
    });

    // 3. Reset des ressources (5 de base + bonus de force)
    imagination = 5 + bonusImagination;
    temps = 3;

    // 4. Pioche et D√©fausse (ton code existant)
    piger(1);
    verifierLimiteMain();

    // Message d'info pour le joueur
    let msg = `Nouveau jour !`;
    if (totalGainFantaisie > 0) msg += `\n+${totalGainFantaisie} Fantaisie via vos activit√©s.`;
    if (bonusImagination > 0) msg += `\n+${bonusImagination} Imagination via la force de vos personnages !`;
    alert(msg);

    actualiserStats();
    afficherMain();
}
    // ... tes r√©solutions d'activit√©s existantes ...
    
    // Phase de Pioche
    if (deck.length > 0) mainJoueur.push(deck.shift());

    // VERIFICATION DE LA LIMITE
    verifierLimiteMain();

    // Reset ressources
    imagination = 5;
    temps = 3;
    
    actualiserStats();
    afficherMain();
}
    function effetMusique() {
    const notes = ["‚ô™", "‚ô´", "‚ô¨", "‚ô©"];
    for (let i = 0; i < 15; i++) {
        setTimeout(() => {
            const note = document.createElement('div');
            note.className = 'note-musique';
            note.innerText = notes[Math.floor(Math.random() * notes.length)];
            
            // Apparition al√©atoire autour du centre
            note.style.left = (window.innerWidth / 2 + (Math.random() * 200 - 100)) + 'px';
            note.style.top = (window.innerHeight / 2 + (Math.random() * 200 - 100)) + 'px';
            
            document.body.appendChild(note);
            
            // Nettoyage
            setTimeout(() => note.remove(), 2000);
        }, i * 100);
    }
}
    initialiserJeu();
</script>
</body>
</html>

