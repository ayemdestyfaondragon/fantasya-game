<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Fantasya - Le Jeu Officiel</title>
    <style>
        body { background: #1a1a2e; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; }
        
        #status-bar { background: #16213e; padding: 15px; display: flex; justify-content: space-around; align-items: center; border-bottom: 3px solid #e94560; }
        .stat { font-size: 16px; font-weight: bold; background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; }
        .stat span { color: #e94560; font-size: 20px; }

        #game-board { height: 50vh; display: flex; align-items: center; justify-content: center; gap: 15px; padding: 20px; flex-wrap: wrap; overflow-y: auto; }
        #player-hand { height: 35vh; display: flex; justify-content: center; align-items: center; gap: 8px; padding: 10px; background: rgba(0,0,0,0.4); border-top: 2px solid #444; overflow-x: auto; }

        .card { width: 120px; height: 170px; background: white; color: #333; border-radius: 10px; padding: 8px; font-size: 11px; cursor: pointer; transition: all 0.3s; border: 3px solid #333; position: relative; display: flex; flex-direction: column; flex-shrink: 0; }
        .jouable { border-color: #ffd700 !important; box-shadow: 0 0 15px #ffd700; transform: translateY(-10px); }
        
        .card.personnage { border-color: #2196f3; }
        .card.activit√© { border-color: #ff9800; }
        .card.chanson { border-color: #9c27b0; background: #fdf0ff; }
        .card.objet { border-color: #4caf50; }

        .card-header { font-weight: bold; border-bottom: 1px solid #ccc; margin-bottom: 3px; font-size: 10px; text-align: center; color: #000; min-height: 25px; }
        .card-img { width: 100%; height: 60px; background: #eee; border-radius: 4px; object-fit: cover; margin-bottom: 3px; }
        .card-rules { flex-grow: 1; font-size: 8px; line-height: 1.1; overflow: hidden; color: #444; }
        .card-footer { display: flex; justify-content: space-between; font-weight: bold; font-size: 11px; }

        .occupe { opacity: 0.6; filter: grayscale(100%); border: 3px dashed #ff9800 !important; }
        .note-musique { position: fixed; color: #9c27b0; font-size: 24px; pointer-events: none; z-index: 2000; animation: envoler 2s ease-out forwards; }
        @keyframes envoler { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-200px); opacity: 0; } }

        #discard-pile { position: fixed; bottom: 20px; right: 20px; width: 80px; height: 110px; background: rgba(255, 255, 255, 0.1); border: 2px solid #e94560; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #e94560; font-size: 10px; text-align: center; }
        #victory-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; }
        button { background: #e94560; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        /* Zone sp√©cifique pour les objets pos√©s */
        #object-zone {
        position: fixed;
        left: 10px;
        top: 100px;
        width: 140px;
        display: flex;
        flex-direction: column;
        gap: 10px;
}

        .card.objet {
        border-color: #4caf50 !important;
        background: #f1fff2 !important;
        height: 120px; /* Plus petits une fois pos√©s */
        width: 90px;
        font-size: 9px;
}

        .card.objet .card-img { height: 40px; }
    </style>
</head>
<body>

<div id="victory-screen">
    <h1 style="color: #ffd700;">VICTOIRE !</h1>
    <button onclick="location.reload()">Rejouer</button>
</div>

<div id="status-bar">
    <div class="stat">Pioche: <span id="deck-count">0</span></div>
    <div class="stat">Fantaisie: <span id="fantaisie">0</span>/50</div>
    <div class="stat">Imagination: <span id="imagination">5</span></div>
    <div class="stat">Temps: <span id="temps">3</span></div>
    <button id="btn-mulligan" onclick="mulligan()">Mulligan</button>
    <button onclick="finirTour()">Dormir</button>
</div>
<div id="object-zone"></div>
<div id="game-board"></div>
<div id="player-hand"></div>
<div id="discard-pile" onclick="defausserManuelle()">D√©fausse<br>(Cliquez)</div>

<script>
    let bddCartes = [], deck = [], mainJoueur = [], activitesEnAttente = [], pileDefausse = [];
    let imagination = 5, temps = 3, scoreFantaisie = 0, mulliganFait = false;
    let objetsActifs = [];
    async function initialiserJeu() {
        try {
            const response = await fetch('./fantasya_cards.json');
            bddCartes = await response.json();
            deck = [...bddCartes].sort(() => 0.5 - Math.random());
            mainJoueur = deck.splice(0, 7);
            actualiserStats();
            afficherMain();
        } catch (e) { alert("Erreur de chargement du fichier JSON !"); }
    }

    function afficherMain() {
        const handDiv = document.getElementById('player-hand');
        handDiv.innerHTML = "";
        mainJoueur.forEach((carte, index) => {
            const cardEl = document.createElement('div');
            const estJouable = imagination >= carte.cout ? "jouable" : "";
            cardEl.className = `card ${carte.type.toLowerCase()} ${estJouable}`;
            cardEl.innerHTML = `
                <div class="card-header">${carte.nom}</div>
                <img class="card-img" src="./images/${carte.id}.png" onerror="this.style.display='none'">
                <div class="card-rules">${carte.regles}</div>
                <div class="card-footer">
                    <span>üíé ${carte.cout}</span>
                    <span>${carte.stats ? '‚öîÔ∏è'+carte.stats.force : '‚ú®'}</span>
                </div>
            `;
            cardEl.onclick = () => jouerCarte(index);
            handDiv.appendChild(cardEl);
        });
    }

    function jouerCarte(index) {
        const carte = mainJoueur[index];
        if (imagination >= carte.cout) {
            imagination -= carte.cout;
            if (carte.type === "Personnage") {
                poserSurTerrain(carte);
                appliquerEffet(carte);
            } else if (carte.type === "Chanson") {
                effetMusique();
                appliquerEffet(carte);
                pileDefausse.push(carte);
            } else if (carte.type === "Activit√©") {
                if (temps >= 1) {
                    lancerActivite(carte);
                } else { imagination += carte.cout; alert("Plus de Temps !"); return; }
            }
            // Dans jouerCarte, ajoute ce bloc :
            else if (carte.type === "Objet") {
                poserObjet(carte);
}

    // Nouvelle fonction pour les objets
   function poserObjet(carte) {
    const zone = document.getElementById('object-zone');
    const cardEl = document.createElement('div');
    cardEl.className = "card objet";
    cardEl.dataset.id = carte.id; // On stocke l'ID dans l'√©l√©ment HTML
    
    cardEl.innerHTML = `
        <div class="card-header" style="font-size:8px">${carte.nom}</div>
        <img class="card-img" src="./images/${carte.id}.png" onerror="this.style.display='none'">
        <div class="card-rules" style="font-size:7px">${carte.regles}</div>
    `;
    zone.appendChild(cardEl);
    objetsActifs.push(carte.id);
    
    // Effet imm√©diat √† la pose
    if(carte.id === "0059") alert("La Lampe Magique est pos√©e ! Vos v≈ìux vont s'exaucer...");
}
            mainJoueur.splice(index, 1);
            actualiserStats();
            afficherMain();
        }
    }

    function poserSurTerrain(carte) {
        const board = document.getElementById('game-board');
        const cardEl = document.createElement('div');
        cardEl.className = "card personnage";
        cardEl.innerHTML = `<div class="card-header">${carte.nom}</div><div class="card-footer">üõ°Ô∏è ${carte.stats.endurance}</div>`;
        board.appendChild(cardEl);
    }

    function lancerActivite(carte) {
        const libres = document.querySelectorAll('#game-board .card.personnage:not(.occupe)');
        if (libres.length > 0) {
            temps -= 1;
            libres[0].classList.add('occupe');
            activitesEnAttente.push({ carte: carte, element: libres[0] });
        } else { imagination += carte.cout; alert("Aucun personnage disponible !"); }
    }

    function appliquerEffet(carte) {
        switch(carte.id) {
            case "0005": scoreFantaisie += 5; break; 
            case "0041": temps += 2; break;
            case "0002": imagination += 3; break;
        }
    }

  function finirTour() {
    let bonusPioche = 1;
    let bonusImagination = 0;
    let bonusTemps = 0;
    let bonusFantaisie = 0;

    // 1. Calcul des bonus des objets actifs
    objetsActifs.forEach(id => {
        if (id === "0059") bonusImagination += 2; // Lampe
        if (id === "0097") bonusFantaisie += 5;   // Trident
        if (id === "0036") bonusPioche += 1;      // Miroir
        if (id === "0021") bonusTemps += 1;       // Coquillage
    });

    // 2. R√©solution des activit√©s (ton code existant)
    activitesEnAttente.forEach(act => {
        scoreFantaisie += 8;
        act.element.classList.remove('occupe');
    });
    activitesEnAttente = [];

    // 3. Application des bonus
    scoreFantaisie += bonusFantaisie;
    piger(bonusPioche);
    
    // 4. Reset Ressources (Base + Bonus)
    const persos = document.querySelectorAll('#game-board .card.personnage');
    imagination = 5 + persos.length + bonusImagination;
    temps = 3 + bonusTemps;

    // 5. Nettoyage main
    if (mainJoueur.length > 10) mainJoueur.splice(0, mainJoueur.length - 10);
    
    actualiserStats();
    afficherMain();

    // Petit rapport de d√©but de journ√©e
    let rapport = "Le soleil se l√®ve !";
    if (bonusImagination > 0 || bonusTemps > 0) rapport += `\nVos objets vous ont aid√© !`;
    alert(rapport);
}
    // On pioche selon le nombre d'objets
    piger(bonusPioche);
    
    // ... reset ressources et stats ...
    alert(`Matin : Vous avez pioch√© ${bonusPioche} carte(s) gr√¢ce √† vos objets.`);
    actualiserStats();
    afficherMain();
}

    function mulligan() {
        if(!mulliganFait) {
            deck.push(...mainJoueur);
            deck.sort(() => 0.5 - Math.random());
            mainJoueur = deck.splice(0, 7);
            mulliganFait = true;
            document.getElementById('btn-mulligan').disabled = true;
            afficherMain();
        }
    }

    function defausserManuelle() {
        if(mainJoueur.length > 0) {
            pileDefausse.push(mainJoueur.pop());
            afficherMain();
            actualiserStats();
        }
    }

    function effetMusique() {
        for (let i = 0; i < 10; i++) {
            const n = document.createElement('div');
            n.className = 'note-musique';
            n.innerText = "‚ô™";
            n.style.left = (Math.random() * window.innerWidth) + 'px';
            n.style.top = (window.innerHeight / 2) + 'px';
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 2000);
        }
    }

    function actualiserStats() {
        document.getElementById('imagination').innerText = imagination;
        document.getElementById('temps').innerText = temps;
        document.getElementById('fantaisie').innerText = scoreFantaisie;
        document.getElementById('deck-count').innerText = deck.length;
        if (scoreFantaisie >= 50) document.getElementById('victory-screen').style.display = 'flex';
    }

    initialiserJeu();
</script>
</body>
</html>


